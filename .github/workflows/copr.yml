# SPDX-License-Identifier: MIT
# SPDX-FileCopyrightText: 2025 Ericky

name: Fedora Copr

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  copr-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(grep "version:" meson.build | head -1 | sed "s/.*version: '\([^']*\)'.*/\1/")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Create source tarball
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p /tmp/gst-cuda-dmabuf-${VERSION}
          tar --exclude='.git' --exclude='builddir' --exclude='target' \
              -czf /tmp/gst-cuda-dmabuf-${VERSION}.tar.gz \
              --transform="s,^,gst-cuda-dmabuf-${VERSION}/," \
              --exclude='gst-cuda-dmabuf-*.tar.gz' .
          mv /tmp/gst-cuda-dmabuf-${VERSION}.tar.gz .

      - name: Install Copr CLI and RPM tools
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip rpm
          pip3 install copr-cli

      - name: Configure Copr
        run: |
          mkdir -p ~/.config
          cat > ~/.config/copr << EOF
          [copr-cli]
          login = ${{ secrets.COPR_LOGIN }}
          username = ${{ secrets.COPR_USERNAME }}
          token = ${{ secrets.COPR_TOKEN }}
          copr_url = https://copr.fedorainfracloud.org
          EOF
          chmod 600 ~/.config/copr

      - name: Build SRPM and submit to Copr
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Update spec file with correct version
          sed -i "s/^Version:.*/Version:        ${VERSION}/" gst-cuda-dmabuf.spec
          
          # Setup rpmbuild directories
          mkdir -p ~/rpmbuild/{SOURCES,SPECS,SRPMS}
          
          # Copy tarball to SOURCES
          cp gst-cuda-dmabuf-${VERSION}.tar.gz ~/rpmbuild/SOURCES/
          
          # Copy spec to SPECS
          cp gst-cuda-dmabuf.spec ~/rpmbuild/SPECS/
          
          # Build SRPM
          rpmbuild -bs ~/rpmbuild/SPECS/gst-cuda-dmabuf.spec \
            --define "_topdir $HOME/rpmbuild" \
            --define "_sourcedir $HOME/rpmbuild/SOURCES"
          
          # Find the SRPM
          SRPM=$(find ~/rpmbuild/SRPMS -name "*.src.rpm" | head -1)
          echo "Built SRPM: $SRPM"
          
          # Submit to Copr
          copr-cli build ${{ secrets.COPR_PROJECT }} \
            --nowait \
            "$SRPM"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: source-tarball
          path: gst-cuda-dmabuf-*.tar.gz
